#!/bin/bash

#This file is transferred to the Cumulus VX and executed to re-map interfaces
#Extra config COULD be added here but I would recommend against that to keep this file standard.
echo "#################################"
echo "  Running Switch Post Config"
echo "#################################"
sudo su

echo "  Adding admin user"
useradd -G wheel -s /bin/bash admin

echo "  Configuring interfaces"
## initialize all mgmt ports
PORTS=""
for i in `seq 1 16`; do
PORTS="$PORTS swp$i"
mkdir -p /etc/net/ifaces/swp$i
cat <<EOF > /etc/net/ifaces/swp$i/options
TYPE=eth
DISABLED=no
ONBOOT=yes
EOF
done
## create simple bridge and assign all ports to it
mkdir -p /etc/net/ifaces/br0
cat <<EOF > /etc/net/ifaces/br0/options
TYPE=bri
HOST='$PORTS'
BOOTPROTO=ipv4ll
ONBOOT=yes
EOF

## Convenience code. This is normally done in ZTP.
echo "  Configuring SSH keys"
mkdir -p /root/.ssh
mkdir -p /home/admin/.ssh
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzH+R+UhjVicUtI0daNUcedYhfvgT1dbZXgY33Ibm4MOo+X84Iwuzirm3QFnYf2O3uyZjNyrA6fj9qFE7Ekul4bD6PCstQupXPwfPMjns2M7tkHsKnLYjNxWNql/rCUxoH2B6nPyztcRCass3lIc2clfXkCY9Jtf7kgC2e/dmchywPV5PrFqtlHgZUnyoPyWBH7OjPLVxYwtCJn96sFkrjaG9QDOeoeiNvcGlk4DJp/g9L4f2AaEq69x8+gBTFUqAFsD8ecO941cM8sa1167rsRPx7SK3270Ji5EUF3lZsgpaiIgMhtIB/7QNTkN9ZjQBazxxlNVN6WthF8okb7OSt" >> /root/.ssh/authorized_keys
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzH+R+UhjVicUtI0daNUcedYhfvgT1dbZXgY33Ibm4MOo+X84Iwuzirm3QFnYf2O3uyZjNyrA6fj9qFE7Ekul4bD6PCstQupXPwfPMjns2M7tkHsKnLYjNxWNql/rCUxoH2B6nPyztcRCass3lIc2clfXkCY9Jtf7kgC2e/dmchywPV5PrFqtlHgZUnyoPyWBH7OjPLVxYwtCJn96sFkrjaG9QDOeoeiNvcGlk4DJp/g9L4f2AaEq69x8+gBTFUqAFsD8ecO941cM8sa1167rsRPx7SK3270Ji5EUF3lZsgpaiIgMhtIB/7QNTkN9ZjQBazxxlNVN6WthF8okb7OSt" >> /home/admin/.ssh/authorized_keys
chmod 700 -R /root/.ssh
chmod 700 -R /home/admin/.ssh

echo "#################################"
echo "   Finished"
echo "#################################"
